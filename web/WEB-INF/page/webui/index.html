<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>卖书</title>
    <link rel="stylesheet" href="${css}/webui/weui.css"/>
    <link rel="stylesheet" href="${css}/webui/example.css"/>
    <link rel="stylesheet" type="text/css" href="${css}/m.css" />
    <link rel="stylesheet" type="text/css" href="${css}/mindex.css" />
</head>
<body ontouchstart>
<div class="header">
    <a class="back-icon" href="#"></a>
    卖书
</div>
<div class="container" id="container"></div>

<script type="text/html" id="tpl_home">
    <form id="form1" method="post" action="">
    <div class="weui_cells">
    <div class="weui_cell weui_cell_warn">
        <div class="weui_cell_hd" style="width:60px;"><label for="" class="weui_label">ISBN:</label></div>
        <div class="weui_cell_bd weui_cell_primary" >
            <input class="weui_input" type="number" pattern="[0-9]*" id="isbn10" name="isbn10" value="weui input error" placeholder="&nbsp;请直接输入或点击右侧图标扫描" style="font-size: 12px;"/>
        </div>
        <div class="weui_cell_ft">
            <img  src="${css}/webui/images/saoma.png" width="30px;" height="30px;"/>
        </div>
    </div>
     </div>
    <div class="weui_cells weui_cells_form">
        <div class="weui_toptips weui_warn js_tooltips">格式不对</div>
        <div id="toast" style="display: none;">
            <div class="weui_mask_transparent"></div>
            <div class="weui_toast">
                <i class="weui_icon_toast"></i>
                <p class="weui_toast_content">已完成</p>
            </div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_hd weui_cell_primary" style="width:20%">
                <div class="weui_uploader">
                    <!--<div class="weui_uploader_hd weui_cell">
                        <div class="weui_cell_bd weui_cell_primary">图片上传</div>
                        <div class="weui_cell_ft">0/2</div>
                    </div>-->
                    <div class="weui_uploader_bd" style="width:60%">
                        <ul class="weui_uploader_files"  id="img1">
                            <li id="chooseImage" class="weui_uploader_file weui_uploader_status" style="background-image:url(${images}/upload.png)">
                            </li>
                           <!-- <li class="weui_uploader_file weui_uploader_status" style="background-image:url(http://shp.qpic.cn/weixinsrc_pic/pScBR7sbqjOBJomcuvVJ6iacVrbMJaoJZkFUIq4nzQZUIqzTKziam7ibg/)">
                                <div class="weui_uploader_status_content">50%</div>
                            </li>-->
                        </ul>
                      <!--  <div class="weui_uploader_input_wrp">
                            <input class="weui_uploader_input" type="file" accept="image/jpg,image/jpeg,image/png,image/gif" multiple  />
                        </div>-->
                    </div>
                </div>
            </div>
            <div class="weui_cell_hd" style="width:64%;padding-bottom:29px;">
                <div class="weui_cell_right">
                    <div class="weui_cell_hd" style="width:30%"><label for="" class="weui_label">书名</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input_right" type="text" id="title" name="title"  />
                    </div>
                </div>
                <div class="weui_cell_right">
                    <div class="weui_cell_hd" style="width:30%"><label for="" class="weui_label">作者</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input_right" type="text" id="author" name="author"  />
                    </div>
                </div>
                <div class="weui_cell_right">
                    <div class="weui_cell_hd" style="width:30%"><label for="" class="weui_label">出版社</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input_right" type="text" id="publisher" name="publisher"   />
                    </div>
                </div>
                <div class="weui_cell_right">
                    <div class="weui_cell_hd" style="width:30%"><label for="" class="weui_label">版次</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input_right" id="binding" name="binding" type="text" pattern="[0-9]*"  />
                    </div>
                </div>
            </div>
        </div>
    </div>
        <div class="weui_cells weui_cells_form">
            <div class="weui_cell">
                <div class="weui_cell_hd" style="width:15%"><label class="weui_label">学校</label></div>
                <div class="weui_cell_bd weui_cell_primary" style="width:30%">
                    <input class="weui_input" type="text" id="school" name="school"  placeholder="学校" style="font-size: 12px;"/>
                </div>
                <div class="weui_cell_hd" style="width:15%"><label class="weui_label">笔记</label></div>
                <div class="weui_cell weui_cell_select">
                            <div class="weui_cell_bd weui_cell_primary">
                                <select class="weui_select" name="biji" id="biji">
                                    <option  value=""></option>
                                    <option value="1">多</option>
                                    <option value="0">少</option>
                                </select>
                            </div>
                </div>
            </div>
            <div class="weui_cell">
                <div class="weui_cell_hd" style="width:15%"><label class="weui_label">数量</label></div>
                <div class="weui_cell_bd weui_cell_primary" style="width:30%">
                    <input class="weui_input" type="number" id="number" name="number" pattern="[0-9]*" placeholder="数量"/>
                </div>
                <div class="weui_cell_hd" style="width:25%"><label class="weui_label">单本售价</label></div>
                <div class="weui_cell_bd weui_cell_primary" style="width:25%">
                    <input class="weui_input" type="number" id="price" name="price" pattern="[0-9]*" placeholder="售价"/>
                </div>
            </div>

            <div class="weui_cell">
                <div class="weui_cell_hd"><label class="weui_label">手机号</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input class="weui_input" type="number" id="mobile" name="mobile" pattern="[0-9]*" placeholder="手机号码"/>
                </div>
            </div>
          <!--  <div class="weui_cell weui_vcode weui_cell_warn">
                <div class="weui_cell_hd"><label class="weui_label">验证码</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input class="weui_input" type="number" placeholder="请输入验证码"/>
                </div>
                <div class="weui_cell_ft">
                    <i class="weui_icon_warn"></i>
                    <img src="./images/vcode.jpg" />
                </div>
            </div>-->
        </div>

        <div class="weui_btn_area">
            <a class="weui_btn weui_btn_primary" href="javascript:" id="sendBtn" >发布</a>
        </div>
    <div class="weui_cells">
        <div class="weui_cells_tips">增加买卖就能减少伤害</div>
        <div class="weui_cell_ft">—摸风</div>
    </div>
    </div>
   </form>
</script>

<script src="${css}/webui/js/zepto.min.js"></script>
<script src="${css}/webui/js/router.min.js"></script>
<script src="${css}/webui/js/example.js"></script>
</body>

</html>
<script type="text/javascript">
    $(document).ready(function(){
       /* $('#isbn10').live('blur', function (){
            var isbn10=$("#isbn10").val();
            if(isbn10.trim().length!=8||isbn10.trim().length!=8){
                showTips("isbn10值错误,请输入8位或者13位isbn码");
            }
        });
        $('#title').live('blur', function (){
            var title=$("#title").val();
            if(title.trim().length==0){
                showTips("请输入书名");
            }
        });
        $('#author').live('blur', function (){
            var author=$("#author").val();
            if(author.trim().length==0){
                showTips("请输入作者");
            }
        });
        $('#publisher').live('blur', function (){
            var publisher=$("#publisher").val();
            if(publisher.trim().length==0){
                showTips("请输入出版社");
            }
        });*/
        $('#publisher').live('blur', function (){
            var school=$("#school").val();
            if(school.trim().length==0){
                showTips("请输入学校");
            }
        });
        $('#biji').live('blur', function (){
            var biji=$("#biji").val();
            if(biji.trim().length==0){
                showTips("请输入笔记");
            }
        });
        $('#number').live('blur', function (){
            var number=$("#number").val();
            if(number.trim().length==0){
                showTips("请输入数量");
            }
        });
        $('#price').live('blur', function (){
            var price=$("#price").val();
            if(price.trim().length==0){
                showTips("请输入单本售价");
            }
        });
        $('#mobile').live('blur', function (){
            var mobile=$("#mobile").val();
            if(mobile.trim().length==0){
                showTips("请输入手机号码");
            }
        });
        $("#sendBtn").live('click',function () {
            var school=$("#school").val();
            var biji=$("#biji").val();
            var number=$("#number").val();
            var price=$("#price").val();
            var mobile=$("#mobile").val();
            if(school.trim().length==0){
                showTips("请输入学校");
            }
            else if(biji.trim().length==0){
                showTips("请输入笔记");
            }
            else if(number.trim().length==0){
                showTips("请输入数量");
            }
            else if(price.trim().length==0){
                showTips("请输入单本售价");
            }
            else if(mobile.trim().length==0){
                showTips("请输入手机号码");
            }
            save_book();
        })

    });
    function showTips(value){
        $('.js_tooltips').html(value);
        $('.js_tooltips').show();
        setTimeout(function (){
            $('.js_tooltips').hide();
        }, 3000);
        return false;
    }
    function save_book(){
        var url="${cmsReq}/webui/sendbook.html";
        var data=$("#form1").serialize();
        $.ajax({
            type: 'POST',
            url: url ,
            data: data ,
            dataType: "json",
            success: function (data) {
                if(data.success){
                    $(".weui_toast_content").html("发布成功");
                    $("#toast").show();
                    setTimeout(function (){
                        $("#toast").hide();
                        window.location.href="${cmsReq}/webui/sendBookList.html";
                    }, 3000);
                }
            },error:function (err) {

            }

        });
    }
</script>

<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script>
    // 5 图片接口
    // 5.1 拍照、本地选图
    var images = {
        localId: [],
        serverId: [],
        downloadId:[]
    };
    wx.config({
        debug: false,
        appId: '${appid}',
        timestamp:'${timestamp}',
        nonceStr: '${nonceStr}',
        signature: '${signature}',
        jsApiList: [
            'checkJsApi',
            'chooseImage',
            'previewImage',
            'uploadImage',
            'downloadImage',
            'scanQRCode'
        ]
    });
    wx.ready(function () {
        document.querySelector('#scanQRCode1').onclick = function () {
            wx.scanQRCode({
                needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                scanType: ["qrCode", "barCode"], // 可以指定扫二维码还是一维码，默认二者都有
                desc: 'scanQRCode desc',
                success: function (res) {
                    var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                    var ss = result.split(",");
                    var isbn = ss[1];
                    getBookInfoByIsbn(isbn);
                }
            });
            wx.error(function (res) {
                alert("" + res.errMsg);
            });
        };


        document.querySelector('#chooseImage').onclick = function () {
            wx.chooseImage({
                success: function (res) {
                    images.localId = res.localIds;
                    $(function () {
                        if (images.localId.length >1) {
                            alert('只能选择一张图片');
                            return;
                        }
                        $.each(res.localIds, function (i, n) {
                            $("#chooseImage").removeAttr('<img src="' + n + '" width="100%" height="120"/>');
                            $("#chooseImage").removeAttr('style');
                            $("#chooseImage").attr('style','background-image:url('+n+')');
                            upload();
                        });
                    });
                }
            });
        };
        // 5.2 图片预览
        document.querySelector('#previewImage').onclick = function () {
            wx.previewImage({
                current: 'http://img5.douban.com/view/photo/photo/public/p1353993776.jpg',
                urls: [
                    'http://img3.douban.com/view/photo/photo/public/p2152117150.jpg',
                    'http://img5.douban.com/view/photo/photo/public/p1353993776.jpg',
                    'http://img3.douban.com/view/photo/photo/public/p2152134700.jpg'
                ]
            });
        };
        // 5.3 上传图片
        document.querySelector('#uploadImage').onclick = function () {
            if (images.localId.length == 0) {
                alert('请先使用 chooseImage 接口选择图片');
                return;
            }
            var i = 0, length = images.localId.length;
            images.serverId = [];
            upload();
        };

        // 5.4 下载图片
        document.querySelector('#downloadImage').onclick = function () {
            if (images.serverId.length == 0) {
                alert('请先使用 uploadImage 上传图片');
                return;
            }

            // var i = 0, length = images.serverId.length;
            // images.localId = [];
            download();
        };
    });
    function upload() {
        var i = 0,length =  images.localId.length;
        images.serverId = [] ;
        wx.uploadImage({
            localId: images.localId[i].toString(),
            success: function (res) {
                i++;
                images.serverId.push(res.serverId);
                downimage(res.serverId);
                //根据medir_id将微信素材下载到本地服务器
                if (i < length) {
                    upload();
                }
            }, fail: function (res) {
                alert(JSON.stringify(res));
            }
        });
    }

    function test(){
        alert("点击");
        getBookInfoByIsbn("9787208115774");
    }
    function getBookInfoByIsbn(isbn) {
        var url = "${cmsReq}/book/searchByIsbn.html";
        var  data = {"isbn": isbn};
        $.ajax({
            type: 'POST',
            url: url,
            data: data,
            dataType: 'json',
            success: function (data) {
                var data = data.book;
               // console.log(data);
                //alert("获取成功=" + data.title);
                $("#title").val(data.title);
                $("#author").val(data.author);
                $("#publisher").val(data.publisher);
                $("#binding").val(data.binding);
            }, error: function (err) {
                alert("error:" + err);
            }

        });
    }
    function downimage(media_id){
        var url="${cmsReq}/book/downimage.html";
        alert(url);
        $.ajax({
            type: 'POST',
            url: url,
            data: {"media_id":media_id},
            dataType: 'json',
            success: function (data) {
                var flg = data.success;
                if(flg){
                    alert("下载到本地成功");
                    var src="/upload/"+media_id+"";
                }

            }, error: function (err) {
                alert("error:" + eval("("+err.toString()+")"));
            }

        });
    }
    function sendBook(){
        var school=$("#school").val();
        var biji=$("#biji").val();
        var sum=$("#sum").val();
        var mobile=$("#mobile").val();
    }
</script>
